<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GNOSTIC ‚Äî GnosticMagic</title>
<meta name="description" content="Tienda minimal y m√≠stica. Mindprint, Estudio del Doble Lift y Estudio del Empalme." />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Fraunces:opsz,wght@9..144,600;9..144,700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#ffffff; --ink:#111; --muted:#515151; --line:#eee;
    --accent:#ff1593;         /* magenta tienda */
    --accent-ink:#fff;
    --mind:#7d3cff;           /* morado Mindprint */
    --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.06);
    --max:1200px; --g:24px;
    --font-body:'Inter',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    --font-display:'Fraunces',var(--font-body);
  }
  *{box-sizing:border-box}
  html{scroll-behavior:smooth}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--font-body);line-height:1.6}
  a{color:inherit}
  /* Header */
  .hdr{position:sticky;top:0;z-index:50;background:color-mix(in oklab, white 85%, transparent);backdrop-filter:saturate(180%) blur(12px);border-bottom:1px solid var(--line)}
  .nav{max-width:var(--max);margin:0 auto;display:flex;align-items:center;gap:14px;padding:12px var(--g)}
  .brand{display:flex;align-items:center;gap:10px;text-decoration:none}
  .brand img{height:28px}
  .menu{margin-left:auto;display:flex;gap:18px;align-items:center}
  .menu a{padding:8px 6px;border-radius:10px;text-decoration:none;position:relative}
  .menu a::after{content:"";position:absolute;left:10px;right:10px;bottom:4px;height:2px;background:transparent;border-radius:2px;transition:background .2s}
  .menu a:hover::after,.menu a[aria-current="page"]::after{background:var(--accent)}
  .cart-btn{position:relative; display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid var(--line); border-radius:999px; background:#fff; cursor:pointer}
  .cart-count{position:absolute; top:-6px; right:-6px; background:var(--accent); color:#fff; font-weight:700; font-size:12px; border-radius:999px; padding:2px 6px; min-width:22px; text-align:center}
  /* Layout */
  .wrap{max-width:var(--max);margin:0 auto;padding:0 var(--g)}
  .hero{min-height:calc(100vh - 64px);display:grid;place-items:center;text-align:center;padding:80px var(--g)}
  .hero h1{font-family:var(--font-display);font-size:clamp(42px,8vw,84px);line-height:1.05;margin:0 0 10px}
  .rot{font-weight:700;letter-spacing:.02em;font-size:clamp(18px,3vw,26px);color:var(--accent);min-height:1.6em;transition:opacity .18s}
  .section{padding:80px 0}
  .section h2{font-size:clamp(28px,5vw,48px);margin:0 0 12px}
  .lead{color:var(--muted);max-width:72ch}
  /* Cards */
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:24px}
  .card{grid-column:span 12;border:1px solid var(--line);border-radius:var(--radius);overflow:hidden;background:#fff;box-shadow:var(--shadow);display:grid;grid-template-columns:1.4fr 1fr}
  .card.reverse{grid-template-columns:1fr 1.4fr}
  .media{aspect-ratio:4/3;background:#f3f3f5;display:grid;place-items:center;color:var(--muted);font-weight:600}
  .content{padding:28px;display:grid;gap:12px;align-content:center}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;background:#f2f2f3}
  .pill.magenta{background:color-mix(in oklab,var(--accent) 14%,white);color:#7a0a48}
  .pill.purple{background:color-mix(in oklab,var(--mind) 18%,white);color:#3e1a77}
  .btn{display:inline-block;background:var(--accent);color:#fff;text-decoration:none;border:none;border-radius:999px;padding:10px 16px;font-weight:700;cursor:pointer}
  .btn.ghost{background:#fff;color:var(--ink);border:1px solid var(--line)}
  /* About / Contact */
  .prose{max-width:72ch}
  .principles{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:10px}
  .principles li{list-style:none;border:1px solid var(--line);border-radius:12px;background:#fff;padding:12px 14px}
  .contact-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
  .input{padding:12px 14px;border:1px solid var(--line);border-radius:12px;font-size:16px;width:100%}
  .notice{padding:12px 14px;background:#fafafa;border:1px dashed var(--line);border-radius:12px}
  footer{padding:48px 0;border-top:1px solid var(--line);color:var(--muted)}
  /* Modals */
  dialog{border:none;border-radius:16px;padding:0;box-shadow:0 20px 60px rgba(0,0,0,.25);width:min(920px,92vw)}
  dialog::backdrop{background:rgba(0,0,0,.45);backdrop-filter:blur(2px)}
  .modal-h{display:flex;justify-content:space-between;align-items:center;padding:18px 26px;border-bottom:1px solid var(--line)}
  .modal-title{margin:0;font-size:22px}
  .modal-b{padding:26px}
  .icon-btn{background:transparent;border:none;padding:8px;border-radius:10px;cursor:pointer}
  .error{display:none;color:#b00020;font-weight:600}
  /* Cart styles */
  .cart-list{list-style:none; margin:0; padding:0; display:grid; gap:10px}
  .cart-item{display:grid; grid-template-columns: 1fr auto auto; gap:10px; align-items:center; border:1px solid var(--line); border-radius:12px; padding:10px 12px; background:#fff}
  .qty{display:inline-flex; align-items:center; gap:8px}
  .qty button{border:1px solid var(--line); background:#fff; border-radius:8px; padding:4px 8px; cursor:pointer}
  .cart-footer{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:14px}
  .total{font-weight:800}
  /* Avisos (toasts) */
  .toast {
    position: fixed; top: 16px; left: 50%; transform: translateX(-50%);
    background: #111; color: #fff; padding: 12px 16px; border-radius: 12px;
    box-shadow: 0 8px 30px rgba(0,0,0,.25); z-index: 9999;
    display: none; align-items: center; gap: 10px; font-weight: 600;
  }
  .toast.ok { background: #1a7f37; }
  .toast.warn { background: #aa5800; }
  .toast.err { background: #b00020; }
  .toast button{
    margin-left: 8px; background: #fff; color:#111; border: none;
    padding: 6px 10px; border-radius: 8px; cursor: pointer; font-weight: 700;
  }
  /* Responsive */
  @media (max-width:1024px){
    .card,.card.reverse{grid-template-columns:1fr}
    .principles{grid-template-columns:1fr}
    .contact-grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>

<header class="hdr">
  <nav class="nav" aria-label="principal">
    <a class="brand" href="#home">
      <img src="Logo_Gnostic_Negro.png" alt="Gnostic logo" onerror="this.style.display='none'">
      <b>GNOSTIC</b>
    </a>
    <div class="menu">
      <a href="#shop">Shop</a>
      <a href="#about">About</a>
      <a href="#contact">Contact</a>
      <!-- Cart button -->
      <button class="cart-btn" onclick="openCart()" aria-label="Abrir cesta">
        üõí Cesta
        <span id="cart-count" class="cart-count" hidden>0</span>
      </button>
    </div>
  </nav>
</header>

<!-- Aviso superior -->
<div id="toast" class="toast" role="status" aria-live="polite">
  <span id="toast-msg">Mensaje</span>
  <button onclick="hideToast()">Cerrar</button>
</div>

<main id="home" class="wrap hero" aria-labelledby="home-title">
  <div>
    <img src="Logo_Gnostic_Negro.png" alt="Gnostic logo" style="height:96px;margin-bottom:18px" onerror="this.style.display='none'">
    <h1 id="home-title" style="font-family:var(--font-display)">GNOSTIC</h1>
    <div id="rot" class="rot">Love is Magic</div>
  </div>
</main>

<section id="shop" class="wrap section" aria-labelledby="shop-title">
  <h2 id="shop-title">Shop</h2>
  <p class="lead">Cat√°logo minimal. La informaci√≥n es p√∫blica; el <strong>v√≠deo del Empalme</strong> y el <strong>contenido avanzado de Mindprint</strong> requieren contrase√±a tras la compra.</p>

  <div class="grid" style="margin-top:32px">
    <!-- Mindprint -->
    <article class="card">
      <div class="content">
        <span class="pill purple">Mindprint</span>
        <h3 style="margin:0">Mindprint ‚Äî m√©todo/juego</h3>
        <p style="margin:0">Mec√°nica minimal y precisa. El acceso al contenido avanzado (manual/v√≠deo/materiales) requiere contrase√±a.</p>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
          <button class="btn" style="background:var(--mind)" onclick="openMindprint()">Ver detalles</button>
          <button class="btn" onclick="openMindprintGate()">Contenido (con clave)</button>
          <button class="btn" onclick="addToCart('mindprint')">A√±adir a la cesta</button>
        </div>
      </div>
      <div class="media" aria-hidden="true">Imagen Mindprint (a√±ade cuando quieras)</div>
    </article>

    <!-- Estudio del Doble Lift -->
    <article class="card reverse">
      <div class="content">
        <span class="pill">Estudio</span>
        <h3 style="margin:0">Estudio del Doble Lift</h3>
        <p style="margin:0">Tratado conciso y pr√°ctico. Entrega por email tras el pago.</p>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
          <button class="btn" onclick="addToCart('doblelift')">A√±adir a la cesta</button>
        </div>
      </div>
      <div class="media" aria-hidden="true">Imagen Doble Lift</div>
    </article>

    <!-- Estudio del Empalme -->
    <article class="card">
      <div class="content">
        <span class="pill magenta">V√≠deo protegido</span>
        <h3 style="margin:0">Estudio del Empalme</h3>
        <p style="margin:0">Descripci√≥n p√∫blica. Para ver el <strong>v√≠deo</strong> se te entregar√° una contrase√±a tras la compra.</p>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
          <button class="btn" onclick="openEmpalmeGate()">Ver v√≠deo (con clave)</button>
          <button class="btn" onclick="addToCart('empalme')">A√±adir a la cesta</button>
        </div>
      </div>
      <div class="media" aria-hidden="true">Thumbnail v√≠deo Empalme</div>
    </article>
  </div>
</section>

<section id="about" class="wrap section" aria-labelledby="about-title">
  <h2 id="about-title">About</h2>
  <div class="prose">
    <p>Mi pr√°ctica parte de una idea simple: el conocimiento no es acumulaci√≥n, es <strong>direcci√≥n</strong>. GNOSTIC existe para orientar esa direcci√≥n: menos ruido, m√°s precisi√≥n; menos ornamento, m√°s intenci√≥n.</p>
    <p>Trabajo con tres ejes: <strong>silencio</strong> (escuchar la forma), <strong>s√≠mbolo</strong> (condensar significado) y <strong>ritual</strong> (hacer repetible lo que funciona). Est√©tica m√≠nima; experiencia n√≠tida.</p>
    <h3>Valores</h3>
    <ul class="principles">
      <li>Minimalismo m√≠stico ‚Äî blanco/negro; magenta como umbral.</li>
      <li>Exactitud ‚Äî cada palabra y gesto sirven a un prop√≥sito.</li>
      <li>Accesibilidad ‚Äî contraste alto, tipograf√≠a legible.</li>
      <li>Respeto ‚Äî contenidos protegidos tras la compra.</li>
      <li>Velocidad y claridad ‚Äî sin distracciones.</li>
      <li>Contenido primero ‚Äî el s√≠mbolo gu√≠a, no distrae.</li>
    </ul>
  </div>
</section>

<section id="contact" class="wrap section" aria-labelledby="contact-title">
  <h2 id="contact-title">Contact</h2>
  <div class="contact-grid">
    <!-- Endpoint de Formspree ya configurado -->
    <form class="gate" action="https://formspree.io/f/mvgwgylv" method="POST">
      <label>Nombre</label>
      <input class="input" type="text" name="name" required>
      <label>Email</label>
      <input class="input" type="email" name="_replyto" required>
      <label>Mensaje</label>
      <textarea class="input" name="message" rows="5" maxlength="800" required></textarea>
      <!-- anti-bots -->
      <input type="text" name="_gotcha" style="display:none" tabindex="-1" autocomplete="off">
      <!-- URL de retorno con aviso -->
      <input type="hidden" name="_next" value="https://gnosticmagic.com/?contact=ok">
      <input type="hidden" name="_subject" value="Nuevo mensaje desde GNOSTIC">
      <button class="btn" type="submit">Enviar</button>
      <div class="notice">Este formulario usa Formspree (plan gratuito). Recibir√°s las consultas en tu correo.</div>
    </form>
    <div>
      <p class="lead">Tambi√©n puedes escribir a <em>contact@gnosticmagic.com</em> (puede reenviar a tu Gmail con ImprovMX).</p>
      <div style="margin-top:18px"><img src="Logo_Gnostic_MoradoDegradado.png" alt="S√≠mbolo" style="height:80px" onerror="this.style.display='none'"></div>
    </div>
  </div>
</section>

<footer>
  <div class="wrap" style="display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap">
    <small>¬© <span id="year"></span> GNOSTIC</small>
    <nav aria-label="legal" style="display:flex;gap:14px;opacity:.7">
      <a href="#" aria-disabled="true" style="text-decoration:none;color:inherit">T√©rminos</a>
      <a href="#" aria-disabled="true" style="text-decoration:none;color:inherit">Privacidad</a>
    </nav>
  </div>
</footer>

<!-- Modales existentes -->
<dialog id="modal-mindprint" aria-labelledby="modal-mindprint-title">
  <div class="modal-h">
    <h3 id="modal-mindprint-title" class="modal-title">Mindprint</h3>
    <button class="icon-btn" onclick="closeModal('modal-mindprint')" aria-label="Cerrar">‚úï</button>
  </div>
  <div class="modal-b">
    <p style="margin-top:0">Descripci√≥n placeholder de Mindprint. Aqu√≠ ir√° el texto final y, si lo apruebas, una peque√±a galer√≠a.</p>
    <ul>
      <li>Punto 1</li><li>Punto 2</li><li>Punto 3</li>
    </ul>
    <div style="display:flex;gap:12px;margin-top:12px">
      <button class="btn" onclick="addToCart('mindprint')">A√±adir a la cesta</button>
      <button class="btn ghost" onclick="closeModal('modal-mindprint')">Cerrar</button>
    </div>
  </div>
</dialog>

<dialog id="modal-mindprint-gate" aria-labelledby="modal-mindprint-gate-title">
  <div class="modal-h">
    <h3 id="modal-mindprint-gate-title" class="modal-title">Mindprint ‚Äî Acceso a contenido</h3>
    <button class="icon-btn" onclick="closeModal('modal-mindprint-gate')" aria-label="Cerrar">‚úï</button>
  </div>
  <form class="modal-b" onsubmit="return openMindprintProtected(event)">
    <label>Contrase√±a</label>
    <input class="input" id="mindprint-pass" type="password" required>
    <button class="btn" type="submit">Desbloquear</button>
    <div id="mindprint-error" class="error">Contrase√±a incorrecta.</div>
    <p class="notice" style="margin-top:10px">Material reservado para compradores.</p>
  </form>
</dialog>

<dialog id="modal-empalme-gate" aria-labelledby="modal-empalme-title">
  <div class="modal-h">
    <h3 id="modal-empalme-title" class="modal-title">Estudio del Empalme ‚Äî Acceso v√≠deo</h3>
    <button class="icon-btn" onclick="closeModal('modal-empalme-gate')" aria-label="Cerrar">‚úï</button>
  </div>
  <form class="modal-b" onsubmit="return openEmpalme(event)">
    <label>Contrase√±a</label>
    <input class="input" id="empalme-pass" type="password" required>
    <button class="btn" type="submit">Ver v√≠deo</button>
    <div id="empalme-error" class="error">Contrase√±a incorrecta.</div>
    <p class="notice" style="margin-top:10px">El v√≠deo se entrega tras la compra.</p>
  </form>
</dialog>

<dialog id="modal-empalme-video" aria-labelledby="modal-empalme-video-title">
  <div class="modal-h">
    <h3 id="modal-empalme-video-title" class="modal-title">Estudio del Empalme ‚Äî V√≠deo</h3>
    <button class="icon-btn" onclick="closeModal('modal-empalme-video')" aria-label="Cerrar">‚úï</button>
  </div>
  <div class="modal-b">
    <video id="empalme-player" controls playsinline preload="metadata"
      style="width:100%;border-radius:12px;background:#000" controlsList="nodownload">
      <source src="video-empalme-demo.mp4" type="video/mp4">
      Tu navegador no soporta v√≠deo HTML5.
    </video>
    <p class="notice">Contenido protegido. Si necesitas transcript, lo a√±adimos aqu√≠.</p>
  </div>
</dialog>

<!-- CARRITO -->
<dialog id="cart-dialog" aria-labelledby="cart-title">
  <div class="modal-h">
    <h3 id="cart-title" class="modal-title">Tu cesta</h3>
    <button class="icon-btn" onclick="closeModal('cart-dialog')" aria-label="Cerrar">‚úï</button>
  </div>
  <div class="modal-b">
    <ul id="cart-list" class="cart-list"></ul>
    <div class="cart-footer">
      <div class="total">Total: <span id="cart-total">0 ‚Ç¨</span></div>
      <div style="display:flex; gap:10px;">
        <button class="btn ghost" onclick="clearCart()">Vaciar</button>
        <button class="btn" onclick="checkout()">Pagar</button>
      </div>
    </div>
    <p class="notice" style="margin-top:10px">El pago se realiza de forma segura en Stripe.</p>
  </div>
</dialog>

<script>
  // ====== CONFIG ======
  const CONFIG = {
    mindprintPassword: 'mindprint-pro',
    empalmePassword: 'empalme-vid',
    rotator: ['Love is Magic','Knowledge is Magic','All is Magic','Everything is Magic'],
    rotMs: 2600
  };

  // ====== WORKER (cambiar si tu URL fuera otra) ======
  const WORKER_URL = 'https://gnostic-checkout.arctisamuel.workers.dev/';

  // ====== PRODUCTOS (IDs de precio y precio para mostrar) ======
  const PRODUCTS = {
    mindprint:  { name:'Mindprint', priceId:'price_1SAZhY8n9nUoqs4QXBodARDk', eur:40 },
    doblelift:  { name:'Estudio del Doble Lift', priceId:'price_1SBAqw8n9nUoqs4QhnjLpED7', eur:14 },
    empalme:    { name:'Estudio del Empalme',    priceId:'price_1SAZiV8n9nUoqs4QaVmTsn5E', eur:14 }
  };

  // ====== UTILIDADES ======
  const fmt = n => new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(n);

  // A√±o
  document.getElementById('year').textContent = new Date().getFullYear();

  // Rotador
  (function(){
    const el = document.getElementById('rot'), P = CONFIG.rotator;
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches){ el.textContent = P[0]; return;}
    let i=0; setInterval(()=>{ i=(i+1)%P.length; el.style.opacity=0; setTimeout(()=>{ el.textContent=P[i]; el.style.opacity=1; },180)}, CONFIG.rotMs);
  })();

  // Navegaci√≥n activa
  function mark(){ document.querySelectorAll('.menu a').forEach(a=>a.removeAttribute('aria-current')); const id=location.hash||'#home'; const a=document.querySelector('.menu a[href="'+id+'"]'); if(a) a.setAttribute('aria-current','page');}
  addEventListener('hashchange',mark); mark();

  // ====== MODALES EXISTENTES ======
  function openMindprint(){ document.getElementById('modal-mindprint').showModal(); }
  function openMindprintGate(){ document.getElementById('modal-mindprint-gate').showModal(); }
  function openMindprintProtected(e){ e.preventDefault();
    const ok = document.getElementById('mindprint-pass').value.trim() === CONFIG.mindprintPassword;
    document.getElementById('mindprint-error').style.display = ok ? 'none':'block';
    if(ok){ closeModal('modal-mindprint-gate'); alert('Contenido protegido de Mindprint (demo).'); }
    return false;
  }
  function openEmpalmeGate(){ document.getElementById('modal-empalme-gate').showModal(); }
  function openEmpalme(e){ e.preventDefault();
    const ok = document.getElementById('empalme-pass').value.trim() === CONFIG.empalmePassword;
    document.getElementById('empalme-error').style.display = ok ? 'none':'block';
    if(ok){ closeModal('modal-empalme-gate'); document.getElementById('modal-empalme-video').showModal(); }
    return false;
  }
  function closeModal(id){ const d=document.getElementById(id); if(d && d.open) d.close(); }

  // ====== CARRITO ======
  const CART_KEY = 'gnosticCart';
  let cart = loadCart();
  renderCartIcon();

  function loadCart(){
    try{ return JSON.parse(localStorage.getItem(CART_KEY)) || []; }catch(_){ return []; }
  }
  function saveCart(){
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
    renderCartIcon();
  }
  function renderCartIcon(){
    const n = cart.reduce((a,x)=>a+x.qty,0);
    const b = document.getElementById('cart-count');
    if(n>0){ b.hidden=false; b.textContent=n; } else { b.hidden=true; }
  }
  function openCart(){
    renderCartList();
    document.getElementById('cart-dialog').showModal();
  }
  function clearCart(){
    cart = [];
    saveCart();
    renderCartList();
  }
  function addToCart(key){
    const item = PRODUCTS[key];
    if(!item){ alert('Producto no disponible.'); return; }
    const found = cart.find(x=>x.key===key);
    if(found) found.qty += 1;
    else cart.push({ key, qty:1 });
    saveCart();
    renderCartList();
    // feedback r√°pido
    document.querySelector('.cart-btn').animate([{transform:'scale(1)'},{transform:'scale(1.06)'},{transform:'scale(1)'}],{duration:300});
  }
  function decQty(i){
    cart[i].qty = Math.max(1, cart[i].qty-1);
    saveCart(); renderCartList();
  }
  function incQty(i){
    cart[i].qty += 1;
    saveCart(); renderCartList();
  }
  function removeItem(i){
    cart.splice(i,1); saveCart(); renderCartList();
  }
  function renderCartList(){
    const ul = document.getElementById('cart-list');
    ul.innerHTML = '';
    let total = 0;
    if(cart.length===0){
      ul.innerHTML = '<li class="cart-item" style="justify-content:center">Tu cesta est√° vac√≠a.</li>';
    }else{
      cart.forEach((row, i)=>{
        const p = PRODUCTS[row.key];
        const line = p.eur * row.qty; total += line;
        const li = document.createElement('li');
        li.className='cart-item';
        li.innerHTML = `
          <div><strong>${p.name}</strong><br><small>${fmt(p.eur)} √ó ${row.qty}</small></div>
          <div class="qty">
            <button aria-label="Restar" onclick="decQty(${i})">‚àí</button>
            <span>${row.qty}</span>
            <button aria-label="Sumar" onclick="incQty(${i})">+</button>
          </div>
          <div style="display:flex; align-items:center; gap:10px">
            <strong>${fmt(line)}</strong>
            <button class="icon-btn" aria-label="Quitar" onclick="removeItem(${i})">üóëÔ∏è</button>
          </div>
        `;
        ul.appendChild(li);
      });
    }
    document.getElementById('cart-total').textContent = fmt(total);
  }

  // ====== CHECKOUT (Stripe a trav√©s del Worker) ======
  async function checkout(){
    if(cart.length===0){ alert('Tu cesta est√° vac√≠a.'); return; }
    // Prepara items con los Price IDs de Stripe
    const items = cart.map(row => ({ price: PRODUCTS[row.key].priceId, quantity: row.qty }));
    try{
      const res = await fetch(WORKER_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ items })
      });
      const data = await res.json();
      if(data?.url){
        window.location.href = data.url; // redirige a Stripe Checkout
      }else{
        alert('Error al crear el pago: ' + (data?.error || 'desconocido'));
      }
    }catch(err){
      alert('No se pudo conectar con el servidor de pago.');
      console.error(err);
    }
  }

  // ====== TOASTS (avisos) + manejo de retorno ======
  function showToast(msg, type='ok'){
    const t = document.getElementById('toast');
    document.getElementById('toast-msg').textContent = msg;
    t.className = 'toast ' + (type || 'ok');
    t.style.display = 'inline-flex';
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(hideToast, 6000);
  }
  function hideToast(){ document.getElementById('toast').style.display='none'; }

  (function handleReturn(){
    const p = new URLSearchParams(location.search);
    if (p.has('paid')) {
      try { cart = []; saveCart(); renderCartList(); } catch(_) {}
      showToast('¬°Pago completado! Gracias por tu compra. Revisa tu email.', 'ok');
      history.replaceState({}, '', location.pathname);
    }
    if (p.has('cancel')) {
      showToast('Pago cancelado. Puedes reintentarlo cuando quieras.', 'warn');
      history.replaceState({}, '', location.pathname);
    }
    if (p.get('contact') === 'ok') {
      showToast('¬°Mensaje enviado! Te responder√© lo antes posible.', 'ok');
      history.replaceState({}, '', location.pathname);
    }
  })();
</script>

</body>
</html>
